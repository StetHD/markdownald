<!DOCTYPE html>
<html>
<head>
	<title>Markdownald</title>
	<meta charset="UTF8" />

	<link rel="stylesheet" type="text/css" href="css/main.css" />
	<link rel=stylesheet href="node_modules/codemirror/lib/codemirror.css">
	<link href="node_modules/codemirror/theme/ambiance.css" type="text/css" rel="stylesheet" />
	<link href="css/highlightjs/zenburn.css" type="text/css" rel="stylesheet" />
	<link href="css/markdown/markdowncss-dark.css" type="text/css" rel="stylesheet" />

	<script src="libs/winsize.js"></script>
	<script src="libs/jquery-1.10.2.js"></script>
	<script src="node_modules/codemirror/lib/codemirror.js"></script>
	<script src="node_modules/codemirror/mode/markdown/markdown.js"></script>
	<script src="node_modules/codemirror/keymap/extra.js"></script>

</head>
<body>
	<input type="file" id="fileopen" style="display:none" accept=".markdow,.md,.txt" multiple>
	<input type="file" id="filesaveas" style="display:none" nwsaveas />
	<div id="tabs"></div>
	<div id=panes><div id="editors"></div><div id="preview"></div></div>
	<script>
	(function(){
		//--- application settings
		var recentFiles = JSON.parse(localStorage.getItem('settings.recents')) || []
			, lastOpened = JSON.parse(localStorage.getItem('settings.opened')) || []
			, editorTheme = localStorage.getItem('settings.theme-editor') || 'ambiance'
			, fontSize = localStorage.getItem('settings.font-size') || 16
			, maxRecentFileSize = 10
		;

		//-- exposing some global to modules
		global.$ = jQuery;
		global.CodeMirror = CodeMirror;
		global.settings = JSON.parse(localStorage.getItem('settings')) || {};

		//--- setting app menu
		global.gui = require('nw.gui');
		var appMenu = require('./libs/app-menu.js');
		//-- open devtools when in devmode
		~global.gui.App.argv.indexOf('--dev') && global.gui.Window.get().showDevTools();

		var core = require('./libs/core.js')
			, fs = require('fs')
			, editor = require('./libs/editor.js')
			, preview = require('./libs/preview.js')
			, activeEditor
		;
		require('./libs/shortcuts.js');

		//-- bind hidden file input elements
		core.on('menu.file.open', function(){ $('input#fileopen').click(); });
		$('input#fileopen').on('change',function(){
			var i=0, l=this.files.length;
			if( !this.files.length ){
				return;
			}
			for(; i<l; i++){
				core.emit('file.opened',this.files[i].path);
			}
		});
		core.on('file.opened', function(filePath){
			if( ~lastOpened.indexOf(filePath) ){ // todo check for opened file already in the list of opened file (+ remove it when closed)
				return ; // avoid listing twice the same file
			}
			lastOpened.push(filePath);
			localStorage.setItem('settings.recents', JSON.stringify(recentFiles));
			localStorage.setItem('settings.opened', JSON.stringify(lastOpened));
			editor.tabOpen(filePath,fs.readFileSync(filePath).toString());
			if( ~recentFiles.indexOf(filePath)){
				recentFiles.push(filePath);
				if( recentFiles.length > maxRecentFileSize ){
					recentFiles.splice(0, recentFiles.length - maxRecentFileSize);
				}
			}
		});

		core.on('menu.file.saveas', function(){ $('#filesaveas').click(); });
		$('#filesaveas').on('change', function(){
			if(! this.files.length ){
				return;
			}
			activeEditor.changePath(this.files[0].path);
			core.emit('menu.file.save');
		});




		//-- bind editor to preview
		core.on('editor.change', function(editor, content){
			var tab = $('#tab-' + editor.editorId);
			tab.is('.dirty') || tab.addClass('dirty');
			core.emit('preview.update', content);
		});
		core.on('editor.selected', function(editor){
			activeEditor = editor;
			$('#tabs > div').removeClass('active')
				.filter('#tab-'+editor.editorId).addClass('active')
			;
			editor.el.addClass('active').siblings().removeClass('active');
			core.emit('preview.update', editor.editor.getValue());
			editor.editor.refresh();
			$(window).trigger('resize');
		});


		//-- editors ui bindings
		core.on('editor.ready', function(editor){
			// create a tab related to the editor
			var tab = $('<div id="tab-' + editor.editorId + '" title="' + editor.filePath + '"><span class="filename">' + editor.fileName + '</span><span class="close"> X </span></div>')
				.appendTo("#tabs")
				.on('click', function(){core.emit('editor.selected', editor);})
			;
			tab.find('.close')
				.on('click',function(){ core.emit('editor.close', editor)})
			;
			editor.el.appendTo("#editors");
			tab.click();
		});
		core.on('editor.filepath.changed', function(editor, newpath){
			var tab = $('#tabs #tab-' + editor.editorId)
				, oldPath = tab.attr('title')
				, lastOpenId = oldPath ? lastOpened.indexOf(oldPath) : -1
			;
			if( lastOpenId < 0){
				lastOpened.push(newpath);
			} else {
				lastOpened.splice(lastOpenId,1, newpath);
			}
			localStorage.setItem('settings.opened', JSON.stringify(lastOpened));
			$('#tabs #tab-' + editor.editorId).attr('title',newpath)
				.find('.filename').text(editor.fileName)
			;
		});
		core.on('editor.close', function(editor){
			var activeTab = $('#tabs #tab-' + editor.editorId);
			if( activeTab.is('.dirty') && !confirm('File is not saved.\nAre you sure you want to close it anyway ?') ){
				return;
			}
			//-- remove from opened file list
			var lastOpenId = lastOpened.indexOf(editor.filePath);
			if( lastOpenId >= 0 ){
				lastOpened.splice(lastOpenId,1);
				localStorage.setItem('settings.opened', JSON.stringify(lastOpened));
			}
			// get next selected editor if available before removing this one
			var nextEditorTab;
			if( editor === activeEditor){
				nextEditorTab = $('#tabs .active').prev();
				nextEditorTab.length || (nextEditorTab = $('#tabs .active').next());
				core.emit('preview.update');
				activeEditor = undefined;
				nextEditorTab.length && nextEditorTab.click();
			}
			activeTab.remove();
			editor.el.remove();
		});


		//-- menu shortcuts binding
		core.on('menu.file.new', function(){ editor.tabNew(); });
		core.on('menu.file.save', function(){
			if(! (activeEditor && activeEditor.filePath)) {
				core.emit('menu.file.saveas');
			} else {
				fs.writeFileSync(activeEditor.filePath, activeEditor.editor.getValue());
				$('#tab-' + activeEditor.editorId).removeClass('dirty');
			}
		});
		core.on('menu.file.close', function(){
			core.emit('editor.close', activeEditor);
		});
		core.on('menu.edit.bold', function(){
			var sel = activeEditor && activeEditor.editor.getSelection();
			if(! sel ){
				return;
			}
			if( sel.match(/^(__|\*\*)[\s\S]+(\1)$/) ){
				activeEditor.editor.replaceSelection(sel.replace(/^(__|\*\*)([\s\S]+)(\1)$/g,'$2'));
			} else {
				sel && activeEditor.editor.replaceSelection('**' + sel + '**');
			}
		});
		core.on('menu.edit.italic', function(){
			var sel = activeEditor && activeEditor.editor.getSelection();
			if(! sel ){
				return;
			}
			if( sel.match(/^(_|\*)[\s\S]+(\1)$/) ){
				activeEditor.editor.replaceSelection(sel.replace(/^(_|\*)([\s\S]+)(\1)$/g,'$2'));
			} else {
				sel && activeEditor.editor.replaceSelection('_' + sel + '_');
			}
		});
		/*
		core.on('menu.edit.orderedlist',function(){
			if(! activeEditor){
				return;
			}
			var cm = activeEditor.editor;
			if(cm.somethingSelected() ){
				cm.replaceSelection(cm.getSelection().replace(/^(\s*)/mg,'$11. '));
			} else {

			}
			//CodeMirror.commands.indentMore(activeEditor.editor);
		});*/
		core.on('menu.edit.indent',function(){
			activeEditor && CodeMirror.commands.indentMore(activeEditor.editor);
		});
		core.on('menu.edit.outdent',function(){
			activeEditor && CodeMirror.commands.indentLess(activeEditor.editor);
		});


		//-- menu view binding
		function togglePaneFullScreen(paneId){
			var pane = $('#' + paneId)
				, panes=$('#panes')
				, alreadyFullScreen = pane.is('.fullscreen')
			;
			$('body .fullscreen').removeClass('fullscreen');
			if(! alreadyFullScreen ){
				panes.addClass('fullscreen');
				pane.addClass('fullscreen');
			}
		}
		function goTabNextPrev(nextOrPrev){
			var tabs = $('#tabs > div[id^=tab]')
				tab = tabs.filter('.active')
				next = tab[nextOrPrev]('div[id^=tab]')
			;
			next.length || (next = tabs.get(nextOrPrev === 'next' ? 0 : tabs.length - 1));
			next.click();
		}
		core.on('menu.view.fullscreen', function(){
			global.gui.Window.get().toggleFullscreen();
		});
		core.on('menu.view.fullscreen-editor', function(){
			togglePaneFullScreen('editors');
		});
		core.on('menu.view.fullscreen-preview', function(){
			togglePaneFullScreen('preview');
		});
		core.on('menu.view.tab-next', function(){ goTabNextPrev('next')});
		core.on('menu.view.tab-prev', function(){ goTabNextPrev('prev')});


		//-- menu settings binding
		core.on('menu.settings.wrapon', function(){
			global.settings.wrapmode = true;
			editor.cmApplyAll(function(cm){ cm.setOption('lineWrapping', true); });
			localStorage.setItem('settings', JSON.stringify(global.settings));
		});
		core.on('menu.settings.wrapoff', function(){
			global.settings.wrapmode = false;
			editor.cmApplyAll(function(cm){ cm.setOption('lineWrapping', false); })
			localStorage.setItem('settings', JSON.stringify(global.settings));
		});

		core.on('menu.settings.font-increment', function(){
			if (fontSize < 51) {
				localStorage.setItem('settings.font-size', ++fontSize);
				core.emit('font-size.change', fontSize);
			}
		});
		core.on('menu.settings.font-decrement', function(){
			if (fontSize > 6) {
				localStorage.setItem('settings.font-size', --fontSize);
				core.emit('font-size.change', fontSize);
			}
		});
		core.on('font-size.change',function(size){ $('body').css('fontSize', size + 'px'); });

		core.on('menu.settings.theme-editor',function(theme){
			var head = $('head');
			if( ! head.find('link[href$="' + theme + '.css"]').length ){
				head.append('<link href="node_modules/codemirror/theme/' + theme + '.css" type="text/css" rel="stylesheet" />');
			}
			$('.CodeMirror').each(function(){
				this.CodeMirror && this.CodeMirror.setOption('theme',theme);
			})
			localStorage.setItem('settings.theme-editor', theme);
		});
		// restore settings
		core.emit('menu.settings.theme-editor', editorTheme);
		core.emit('font-size.change', fontSize);



		//-- restore last opened files if any
		(function(){
			var errors = [];
			lastOpened && lastOpened.forEach(function(filePath){
				try{
					editor.tabOpen(filePath,fs.readFileSync(filePath).toString());
				} catch(e) {
					errors.push(filePath);
				}
			});
			if (errors.length) {
				lastOpened = lastOpened.filter(function(filePath){
					return !~errors.indexOf(filePath);
				});
				localStorage.setItem('settings.opened', JSON.stringify(lastOpened));
				window.alert('Some files were not found:\n\t- ' + errors.join('\n\t- '));
			}
		})();

		// open from command line
		global.gui.App.argv.forEach(function(arg){
			if (fs.existsSync(arg)) {
				editor.tabOpen(fs.realpathSync(arg), fs.readFileSync(arg).toString());
			}
		})

		// if no file opened open a new one
		$('#tabs > div').length || core.emit('menu.file.new');


		//-- avoid quiting with dirty files
		global.gui.Window.get().on('close', function(){
			core.emit('application.close');
		});
		core.on('application.close',function(){
			saveWindowState();
			if( ! $('#tabs .dirty').length ){
				global.gui.App.quit();
			} else if( window.confirm('Some files seems unsaved.\nAre you sure you want to quit ?')) {
				global.gui.App.quit();
			}
		});

	})();
	</script>
</body>
</html>
