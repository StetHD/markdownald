<!DOCTYPE html>
<html>
<head>
	<title>Markdownald</title>
	<meta charset="UTF8" />

	<link rel="stylesheet" type="text/css" href="css/main.css" />
	<link rel=stylesheet href="node_modules/codemirror/lib/codemirror.css">
	<link href="node_modules/codemirror/theme/ambiance.css" type="text/css" rel="stylesheet" />
	<link href="css/highlightjs/zenburn.css" type="text/css" rel="stylesheet" />
	<link href="css/markdown/markdowncss-dark.css" type="text/css" rel="stylesheet" />

	<script src="libs/winsize.js"></script>
	<script src="libs/jquery-1.10.2.js"></script>
	<script src="node_modules/codemirror/lib/codemirror.js"></script>
	<script src="node_modules/codemirror/mode/markdown/markdown.js"></script>
	<script src="node_modules/codemirror/keymap/extra.js"></script>

</head>
<body>
	<input type="file" id="fileopen" style="display:none" accept=".markdow,.md,.txt" multiple>
	<input type="file" id="filesaveas" style="display:none" nwsaveas />
	<div id="tabs"></div>
	<div id=panes><div id="editors"></div><div id="preview"><div class="content"></div></div></div>
	<script>
	(function(){

		// prevent default behavior from changing page on dropped file
		window.ondragover = function(e) { e.preventDefault(); return false };
		window.ondrop = function(e) { e.preventDefault(); return false };

		//-- exposing some global to modules
		global.$ = jQuery;
		global.CodeMirror = CodeMirror;

		//--- application settings
		var settings = global.settings = JSON.parse(localStorage.getItem('settings')) || {
			recentFiles: []
			, lastOpened: []
			, fontSize: 16
			, maxRecentFileSize: 10
			, editorTheme: 'ambiance'
		};

		//--- setting app menu
		global.gui = require('nw.gui');
		var appMenu = require('./libs/app-menu.js');
		//-- open devtools when in devmode
		~global.gui.App.argv.indexOf('--dev') && global.gui.Window.get().showDevTools();

		var core = require('./libs/core.js')
			, fs = require('fs')
			, editor = require('./libs/editor.js')
			, preview = require('./libs/preview.js')
		;
		require('./libs/shortcuts.js');
		require('./libs/files.js');

		//-- storage exposition
		core.on('storage.set', function(key, val){
			localStorage.setItem(key, JSON.stringify(val));
		});
		core.on('storage.get', function(key, cb){
			cb && cb(JSON.parse(localStorage.setItem(key)));
		});

		//-- bind hidden file input elements
		$('input#fileopen').on('change',function(){
			var i=0, l=this.files.length;
			if( !this.files.length ){
				return;
			}
			for(; i<l; i++){
				core.emit('file.opened',this.files[i].path);
			}
		});

		$('#filesaveas').on('change', function(){
			if(! this.files.length ){
				return;
			}
			editor.getActive().changePath(this.files[0].path);
			core.emit('file.save');
		});




		//-- bind editor to preview
		core.on('editor.change', function(editor, content){
			var tab = $('#tab-' + editor.editorId);
			tab[editor.editor.isClean() ? 'removeClass' : 'addClass']('dirty');
			core.emit('preview.update', content);
		});
		core.on('editor.selected', function(editor){
			core.emit('activeEditor.set', editor);
			$('#tabs > div').removeClass('active')
				.filter('#tab-'+editor.editorId).addClass('active')
			;
			editor.el.addClass('active').siblings().removeClass('active');
			core.emit('preview.update', editor.editor.getValue());
			editor.editor.refresh();
			$(window).trigger('resize');
		});


		//-- editors ui bindings
		core.on('editor.ready', function(editor){
			// create a tab and pane related to the editor
			var tabTemplate = '<div id="tab-' + editor.editorId + '" title="' + editor.filePath + '"><span class="filename">' + editor.fileName + '</span><span class="close"> X </span></div>'
				, paneTemplate = '<div></div>'
				, tab = $(tabTemplate).appendTo("#tabs")
				, pane = $(paneTemplate).appendTo("#editors")
			;
			tab.on('click', function(){core.emit('editor.selected', editor);});
			$('.close', tab).on('click',function(){ core.emit('editor.close', editor)});
			editor.init(pane);
			tab.click();
		});
		core.on('editor.filepath.changed', function(editor, newpath){
			var tab = $('#tabs #tab-' + editor.editorId)
				, oldPath = tab.attr('title')
				, lastOpenId = oldPath ? settings.lastOpened.indexOf(oldPath) : -1
			;
			if( lastOpenId < 0){
				settings.lastOpened.push(newpath);
			} else {
				settings.lastOpened.splice(lastOpenId,1, newpath);
			}
			core.emit('settings.save');
			$('#tabs #tab-' + editor.editorId).attr('title',newpath)
				.find('.filename').text(editor.fileName)
			;
		});
		core.on('editor.close', function(editorInstance){
			var activeTab = $('#tabs #tab-' + editorInstance.editorId);
			if( activeTab.is('.dirty') && !confirm('File is not saved.\nAre you sure you want to close it anyway ?') ){
				return;
			}
			//-- remove from opened file list
			var lastOpenId = settings.lastOpened.indexOf(editorInstance.filePath);
			if( lastOpenId >= 0 ){
				settings.lastOpened.splice(lastOpenId,1);
				core.emit('settings.save');
			}
			// get next selected editorInstance if available before removing this one
			var activeEditor = editor.getActive(), nextEditorTab;
			if( editorInstance === activeEditor){
				nextEditorTab = $('#tabs .active').prev();
				nextEditorTab.length || (nextEditorTab = $('#tabs .active').next());
				core.emit('activeEditor.set', undefined);
				nextEditorTab.length && nextEditorTab.click();
			}
			activeTab.remove();
			editorInstance.el.remove();
		});


		//-- menu shortcuts binding
		/*
		core.on('edit.orderedlist',function(){
			if(! activeEditor){
				return;
			}
			var cm = activeEditor.editor;
			if(cm.somethingSelected() ){
				cm.replaceSelection(cm.getSelection().replace(/^(\s*)/mg,'$11. '));
			} else {

			}
			//CodeMirror.commands.indentMore(activeEditor.editor);
		});*/


		//-- menu view binding
		function togglePaneFullScreen(paneId){
			var pane = $('#' + paneId)
				, panes=$('#panes')
				, alreadyFullScreen = pane.is('.fullscreen')
			;
			$('body .fullscreen').removeClass('fullscreen');
			if(! alreadyFullScreen ){
				panes.addClass('fullscreen');
				pane.addClass('fullscreen');
			}
		}
		function goTabNextPrev(nextOrPrev){
			var tabs = $('#tabs > div[id^=tab]')
				tab = tabs.filter('.active')
				next = tab[nextOrPrev]('div[id^=tab]')
			;
			next.length || (next = tabs.get(nextOrPrev === 'next' ? 0 : tabs.length - 1));
			next.click();
		}
		core.on('view.fullscreen', function(){
			global.gui.Window.get().toggleFullscreen();
		});
		core.on('view.fullscreen-editor', function(){
			togglePaneFullScreen('editors');
		});
		core.on('view.fullscreen-preview', function(){
			togglePaneFullScreen('preview');
		});
		core.on('view.tab-next', function(){ goTabNextPrev('next')});
		core.on('view.tab-prev', function(){ goTabNextPrev('prev')});


		//-- menu settings binding
		core.on('settings.wrapon', function(){
			global.settings.wrapmode = true;
			editor.cmApplyAll(function(cm){ cm.setOption('lineWrapping', true); });
			localStorage.setItem('settings', JSON.stringify(global.settings));
		});
		core.on('settings.wrapoff', function(){
			global.settings.wrapmode = false;
			editor.cmApplyAll(function(cm){ cm.setOption('lineWrapping', false); })
			localStorage.setItem('settings', JSON.stringify(global.settings));
		});

		
		core.on('font-size.change',function(size){
			$('body').css('fontSize', size + 'px');
			var editor = $('.CodeMirror:visible');
			editor.length && editor.get(0).CodeMirror.refresh();
		});


		 core.on('editor.setTheme',function(theme){
			 var head = $('head');
			 if( ! head.find('link[href$="' + theme + '.css"]').length ){
				 head.append('<link href="node_modules/codemirror/theme/' + theme + '.css" type="text/css" rel="stylesheet" />');
			 }
			 core.emit('settings.set','theme-editor', theme);
		 });
		// restore settings
		core.emit('settings.theme-editor', settings.editorTheme);
		core.emit('font-size.change', settings.fontSize);



		//-- restore last opened files if any
		(function(){
			var errors = [];
			settings.lastOpened && settings.lastOpened.forEach(function(filePath){
				try{
					editor.tabOpen(filePath,fs.readFileSync(filePath).toString());
				} catch(e) {
					console.log(e);
					errors.push(filePath);
				}
			});
			if (errors.length) {
				settings.lastOpened = settings.lastOpened.filter(function(filePath){
					return !~errors.indexOf(filePath);
				});
				core.emit('settings.save');
				window.alert('Some files were not found:\n\t- ' + errors.join('\n\t- '));
			}
		})();

		// open from command line
		global.gui.App.argv.forEach(function(arg){
			if (fs.existsSync(arg)) {
				editor.tabOpen(fs.realpathSync(arg), fs.readFileSync(arg).toString());
			}
		})

		// if no file opened open a new one
		$('#tabs > div').length || core.emit('file.new');


		//-- avoid quiting with dirty files
		global.gui.Window.get().on('close', function(){
			core.emit('application.close');
		});
		core.on('application.close',function(){
			saveWindowState();
			if( ! $('#tabs .dirty').length ){
				global.gui.App.quit();
			} else if( window.confirm('Some files seems unsaved.\nAre you sure you want to quit ?')) {
				global.gui.App.quit();
			}
		});

		//-- bind scrollbars togethers
		core.on('editor.scroll', function(){
			var editorScroll = $('.CodeMirror-vscrollbar:visible')
				, preview = $('#preview')
				, eh = editorScroll.children().height()
				, ph = preview.find(' > .content').height()
				, ratio =  ph / eh
			;
			preview.scrollTop( Math.round(ratio * editorScroll.scrollTop()) );
		})
		core.on('editor.change', function(){ core.emit('editor.scroll');})
		document.addEventListener('scroll', function(e){
			if ( ! $(e.target).is('.CodeMirror-vscrollbar:visible') ) {
				return;
			}
			core.emit('editor.scroll');
		}, true);

		//-- allow dropping file
		document.body.addEventListener('drop', function (e) {
			var i = 0, l = e.dataTransfer.files.length, filePath;
			if( l ){
			  e.preventDefault();
			  for(; i < l; i++) {
				filePath = e.dataTransfer.files[i].path;
				filePath.match(/\.(te?xt|markdown|md)$/i)  && core.emit('file.opened', filePath);
			  }
			  return false;
		   }
		}, true);

	})();
	</script>
</body>
</html>
